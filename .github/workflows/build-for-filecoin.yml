name: Build PR Content

# Runs on PRs from forks and same-repo - NO SECRETS
on:
  # Use pull_request_target for both same-repo and fork PRs
  pull_request_target:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]  # Also run when PRs are merged to main
  workflow_dispatch:  # Allow manual build to kick off upload flow

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Use PR head SHA if triggered by pull_request, otherwise use default (push event)
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      # Build the website
      - name: Install dependencies
        run: npm install

      - name: Build website
        run: npm run build

      # Debug: Show what we're about to upload
      - name: Debug - Show dist contents before upload
        run: |
          echo "=== DEBUG: dist folder contents ==="
          ls -la dist/
          echo "=== DEBUG: dist folder size ==="
          du -sh dist/
          echo "=== DEBUG: Individual file sizes ==="
          find dist/ -type f -exec ls -lh {} \; | head -20
          echo "=== DEBUG: Total file count ==="
          find dist/ -type f | wc -l

      # Upload build artifacts to GitHub Actions artifacts
      # The upload workflow will download these artifacts and use them
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.run_id }}
          path: dist
          retention-days: 1
